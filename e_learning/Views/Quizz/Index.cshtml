@model e_learning.Models.QuizViewModel

@{
    Layout = null;
    int totalQuestions = Model.Questions1 != null ? Model.Questions1.Count : 0;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@Model.QuizzesName</title>
    <link href="~/Content/Assets/template03/css/css3.css" rel="stylesheet" />

    <style>
        /* --- HIỆU ỨNG CHUYỂN CẢNH MƯỢT MÀ --- */
        .question-block {
            display: none; /* Mặc định ẩn hết */
        }

            /* Khi câu hỏi được kích hoạt (active) */
            .question-block.active {
                display: block;
                animation: fadeIn 0.5s ease-in-out; /* Hiệu ứng mờ dần trong 0.5s */
            }

        /* Định nghĩa hiệu ứng Fade In */
        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

     
        .palette-item {
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

            .palette-item:hover {
                transform: scale(1.1);
            }

            .palette-item.current {
                background-color: #007bff; /* Màu xanh dương cho câu đang chọn */
                color: #fff;
                border-color: #007bff;
            }

            .palette-item.answered {
                background-color: #28a745; /* Màu xanh lá cho câu đã làm */
                color: #fff;
                border-color: #28a745;
            }
    </style>
</head>
<body>

    <div class="quiz-container">
        <header class="quiz-header">
            @Model.QuizzesName
        </header>

        <form id="quizForm" action="@Url.Action("SubmitQuiz", "Quizz")" method="post">
            <input type="hidden" name="QuizID" value="@Model.QuizzesID" />

            <main class="quiz-body">
                <section class="quiz-main">

                    @if (Model.Questions1 != null && Model.Questions1.Count > 0)
                    {
                        for (int i = 0; i < totalQuestions; i++)
                        {
                            var q = Model.Questions1[i];
                            var index = i + 1;
                            // Chỉ câu đầu tiên có class 'active' để hiện ra
                            var activeClass = (i == 0) ? "active" : "";

                            <div class="question-block @activeClass" id="q-block-@index">

                                <div class="question-header-info">
                                    <h2>Câu hỏi @index</h2>
                                    <div class="flag-question">
                                        <input type="checkbox" id="flag-@q.QuestionsID">
                                        <label for="flag-@q.QuestionsID">Đánh dấu câu hỏi này</label>
                                    </div>
                                </div>

                                <div class="question-passage-container">
                                    <div class="question-passage">
                                        @Html.Raw(q.QuestionsContent)
                                    </div>
                                </div>

                                <div class="answer-options">
                                    <h3>Chọn đáp án đúng:</h3>
                                    <ul class="answer-list">
                                        @if (q.Options != null)
                                        {
                                            foreach (var opt in q.Options)
                                            {
                                                <li>
                                                    <label>
                                                        <input type="radio"
                                                               name="UserAnswers[@q.QuestionsID]"
                                                               value="@opt.AnswerOptionsID"
                                                               onclick="markAsAnswered(@index)">
                                                        <span>@opt.AnswerOptionsName</span>
                                                    </label>
                                                </li>
                                            }
                                        }
                                    </ul>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div style="padding:20px;">Chưa có dữ liệu câu hỏi.</div>
                    }

                </section>

                <aside class="quiz-sidebar">

                    <div class="sidebar-widget">
                        <div class="widget-header">
                            Thời gian còn lại
                        </div>
                        <div class="widget-content">
                            <div class="timer-display" id="timer">
                                --:--
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-widget">
                        <div class="widget-header">
                            Bảng câu hỏi
                        </div>
                        <div class="widget-content">
                            <div class="palette-grid">
                                @for (int i = 1; i <= totalQuestions; i++)
                                {
                                    var activeClass = (i == 1) ? "current" : "";
                                    <div class="palette-item @activeClass"
                                         id="palette-@i"
                                         onclick="goToQuestion(@i)">
                                        @i
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div style="padding: 15px;">
                        <button type="button" class="btn btn-success w-100" onclick="submitForm()">NỘP BÀI</button>
                    </div>

                </aside>

            </main>

            <footer class="quiz-navigation">
                <button type="button" class="btn btn-secondary" id="prev-btn" onclick="moveQuestion(-1)">
                    &lt;&lt; Trang trước
                </button>
                <button type="button" class="btn btn-primary" id="next-btn" onclick="moveQuestion(1)">
                    Trang tiếp &gt;&gt;
                </button>
            </footer>
        </form>
    </div>

    <script>
        // Các biến toàn cục
        var totalQ = @totalQuestions;
        var currentQ = 1;
        var timeLimit = @(Model.TimeLimit > 0 ? Model.TimeLimit : 45); // Phút
        var totalSeconds = timeLimit * 60;

        // --- 1. XỬ LÝ TIMER ---
        function startTimer() {
            var display = document.getElementById('timer');
            var timer = setInterval(function () {
                var minutes = Math.floor(totalSeconds / 60);
                var seconds = totalSeconds % 60;

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;

                if (--totalSeconds < 0) {
                    clearInterval(timer);
                    alert("Hết giờ làm bài!");
                    document.getElementById("quizForm").submit();
                }
            }, 1000);
        }

        // --- 2. XỬ LÝ CHUYỂN CÂU HỎI (MƯỢT MÀ) ---
        function showQuestion(index) {
            // Ẩn câu hiện tại (Bỏ class active)
            document.getElementById('q-block-' + currentQ).classList.remove('active');
            document.getElementById('palette-' + currentQ).classList.remove('current');

            // Cập nhật index mới
            currentQ = index;

            // Hiện câu mới (Thêm class active -> kích hoạt animation fadeIn)
            document.getElementById('q-block-' + currentQ).classList.add('active');
            document.getElementById('palette-' + currentQ).classList.add('current');

            updateNavButtons();
        }

        function moveQuestion(direction) {
            var nextIndex = currentQ + direction;
            if (nextIndex >= 1 && nextIndex <= totalQ) {
                showQuestion(nextIndex);
            }
        }

        function goToQuestion(index) {
            showQuestion(index);
        }

        // --- 3. CẬP NHẬT TRẠNG THÁI NÚT BẤM ---
        function updateNavButtons() {
            var btnPrev = document.getElementById('prev-btn');
            var btnNext = document.getElementById('next-btn');

            // Ẩn nút Previous nếu ở câu 1
            if (currentQ === 1) {
                btnPrev.style.visibility = 'hidden';
            } else {
                btnPrev.style.visibility = 'visible';
            }

            // Đổi nút Next thành Finish nếu ở câu cuối (tuỳ chọn)
            if (currentQ === totalQ) {
                btnNext.innerHTML = "Về cuối >>";
                // Hoặc bạn có thể ẩn nút Next đi nếu muốn
            } else {
                btnNext.innerHTML = "Trang tiếp >>";
            }
        }

        // --- 4. ĐÁNH DẤU ĐÃ LÀM ---
        function markAsAnswered(index) {
            // Thêm class 'answered' vào ô số bên bảng palette
            document.getElementById('palette-' + index).classList.add('answered');
        }

        function submitForm() {
            if(confirm("Bạn có chắc chắn muốn nộp bài?")) {
                document.getElementById("quizForm").submit();
            }
        }

        // --- KHỞI CHẠY ---
        window.onload = function () {
            startTimer();
            updateNavButtons();
        };

    </script>
</body>
</html>